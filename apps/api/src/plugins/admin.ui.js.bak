export default async function adminUi(app) {
  app.get('/v2/admin', async (_req, reply) => {
    const html = `<!doctype html>
<html lang="en"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Litebrygg Admin</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
.card{background:#fff;border-radius:1rem;box-shadow:0 1px 8px rgba(15,23,42,.08);padding:1.25rem}
.btn{padding:.5rem .75rem;border-radius:.75rem;box-shadow:0 1px 4px rgba(15,23,42,.08);font-size:.875rem}
.btn-primary{background:#4f46e5;color:#fff}.btn-soft{background:#f1f5f9;color:#0f172a}
.tag{font-size:.75rem;border-radius:.375rem;padding:.25rem .5rem;background:#f1f5f9}
.grid-auto{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:1rem}
.input{border:1px solid #cbd5e1;border-radius:.5rem;padding:.375rem .5rem;font-size:.875rem}
.table{width:100%;border-collapse:collapse} th,td{padding:.5rem .5rem;text-align:left} thead th{color:#64748b} tr{border-bottom:1px solid #e2e8f0}
</style>
</head>
<body class="bg-slate-50">
<header class="sticky top-0 z-20 bg-slate-900 text-white">
  <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
    <div class="font-semibold flex items-center gap-2">Litebrygg Admin <span id="roleTag" class="tag bg-slate-700 text-white text-xs px-2">…</span></div>
    <nav class="flex gap-2">
      <a href="#/orders" class="tag">Orders</a>
      <a href="#/products" class="tag">Products</a>
      <a href="#/flags" class="tag">Feature Flags</a>
      <a href="/v2/docs" class="tag">Docs</a>
    <a href="#/roles" class="tag">Roles</a><a href="#/activity" class="tag">Activity</a></nav>
  </div>
</header>
<main class="max-w-6xl mx-auto px-4 py-6">
  <div id="notice" class="hidden mb-4"></div>
  <div id="view"></div>
</main>

<script>
(function(){
  
function currentRoleHeader(){
  try { const r = localStorage.getItem('role'); if(r) return {'x-role': r}; } catch(e){}
  return {};
}
const api=(p,opt)=>{ 
  const baseHeaders = {"content-type":"application/json"};
  const hdr = Object.assign({}, baseHeaders, currentRoleHeader(), (opt&&opt.headers)||{});
  const final = Object.assign({}, opt||{}, { headers: hdr });
  return fetch(p, final);
};

  function notice(t,ok){var n=document.getElementById('notice');n.className=ok?'card mb-4 bg-green-50 text-green-900':'card mb-4 bg-rose-50 text-rose-900';n.textContent=t;n.classList.remove('hidden');setTimeout(()=>n.classList.add('hidden'),4000)}
  function fmt(n){try{return new Intl.NumberFormat('no-NO',{style:'currency',currency:'NOK'}).format(Number(n||0))}catch(e){return String(n)}}
  function params(){var q=(location.hash.split('?')[1]||'');return new URLSearchParams(q)}
  function setHash(route,obj){var s=new URLSearchParams(obj).toString();location.hash=route+(s?('?'+s):'')}

  // PRODUCTS
  async function viewProducts(){
    var p=params(); var q=p.get('q')||''; var page=Number(p.get('page')||1); var pageSize=12;
    const r=await api('/v2/integrations/magento/products?page='+page+'&pageSize='+pageSize+'&q='+encodeURIComponent(q));
    const j=await r.json(); const items=j.items||[]; const total=j.total||j.total_count||items.length; const pages=Math.max(1,Math.ceil(total/pageSize));
    var cards=''; items.forEach(function(x){cards+= '<div class="card"><div class="font-semibold mb-1">'+(x.name||'')+'</div><div class="text-sm text-slate-600 mb-2">'+(x.sku||'')+'</div><div class="flex items-center justify-between"><span class="text-sm">'+fmt(x.price)+' · <span class="tag">'+(x.status===1?'Enabled':'Disabled')+'</span></span><a class="btn btn-soft" href="#/product/'+encodeURIComponent(x.sku||'')+'">Open</a></div></div>'});
    document.getElementById('view').innerHTML =
      '<div class="mb-4 flex items-center justify-between"><h1 class="text-xl font-semibold">Products</h1>'+
      '<form id="searchForm" class="flex gap-2"><input id="searchInput" class="input" type="text" placeholder="Search…" value="'+q.replace(/"/g,'&quot;')+'"/><button class="btn btn-primary">Search</button></form></div>'+
      '<div class="grid-auto">'+cards+'</div>'+
      '<div class="mt-4 flex items-center justify-between"><button id="prevPage" class="btn btn-soft" '+(page<=1?'disabled':'')+'>Prev</button><div class="text-sm text-slate-600">Page '+page+' of '+pages+' ('+total+' items)</div><button id="nextPage" class="btn btn-soft" '+(page>=pages?'disabled':'')+'>Next</button></div>';
    document.getElementById('searchForm').onsubmit=function(e){e.preventDefault(); var term=document.getElementById('searchInput').value; setHash('#/products',{q:term,page:1})}
    var pv=document.getElementById('prevPage'); if(pv) pv.onclick=function(){ if(page>1) setHash('#/products',{q:q,page:page-1}) }
    var nx=document.getElementById('nextPage'); if(nx) nx.onclick=function(){ if(page<pages) setHash('#/products',{q:q,page:page+1}) }
  }
  async function viewProduct(sku){
    const r=await api('/v2/integrations/magento/products/'+encodeURIComponent(sku)); const j=await r.json(); const p=j.item||{};
    document.getElementById('view').innerHTML =
      '<div class="flex items-center justify-between mb-4"><h1 class="text-xl font-semibold">'+(p.name||sku)+'</h1><a class="btn btn-soft" href="#/products">Back</a></div>'+
      '<div class="card"><div class="text-sm text-slate-600 mb-2">SKU: '+(p.sku||'')+'</div><div class="mb-2">Price: <b>'+fmt(p.price)+'</b></div><div>Status: <span class="tag">'+(p.status===1?'Enabled':'Disabled')+'</span></div></div>';
  }

  // ORDERS
  async function viewOrders(){
    var p=params(); var q=p.get('q')||''; var page=Number(p.get('page')||1); var pageSize=10;
    const r=await api('/v2/integrations/magento/orders?page='+page+'&pageSize='+pageSize+'&q='+encodeURIComponent(q));
    const j=await r.json(); const list=j.items||[]; const total=j.total||j.total_count||list.length; const pages=Math.max(1,Math.ceil(total/pageSize));
    var rows=''; list.forEach(function(o){rows+='<tr><td>'+o.entity_id+'</td><td>'+(o.increment_id||'')+'</td><td>'+(o.status||'')+'</td><td>'+fmt(o.grand_total)+'</td><td class="text-right"><a class="btn btn-soft" href="#/order/'+o.entity_id+'">Open</a></td></tr>'});
    document.getElementById('view').innerHTML =
      '<div class="mb-4 flex items-center justify-between"><h1 class="text-xl font-semibold">Orders</h1>'+
      '<form id="orderSearch" class="flex gap-2"><input id="orderInput" class="input" type="text" placeholder="Search ID / keyword" value="'+q.replace(/"/g,'&quot;')+'"/><button class="btn btn-primary">Search</button></form></div>'+
      '<div class="card overflow-auto"><table class="table text-sm"><thead><tr><th>ID</th><th>Increment</th><th>Status</th><th>Total</th><th></th></tr></thead><tbody>'+rows+'</tbody></table></div>'+
      '<div class="mt-4 flex items-center justify-between"><button id="orderPrev" class="btn btn-soft" '+(page<=1?'disabled':'')+'>Prev</button><div class="text-sm text-slate-600">Page '+page+' of '+pages+' ('+total+' orders)</div><button id="orderNext" class="btn btn-soft" '+(page>=pages?'disabled':'')+'>Next</button></div>';
    document.getElementById('orderSearch').onsubmit=function(e){e.preventDefault(); var term=document.getElementById('orderInput').value; setHash('#/orders',{q:term,page:1})}
    var pv=document.getElementById('orderPrev'); if(pv) pv.onclick=function(){ if(page>1) setHash('#/orders',{q:q,page:page-1}) }
    var nx=document.getElementById('orderNext'); if(nx) nx.onclick=function(){ if(page<pages) setHash('#/orders',{q:q,page:page+1}) }
  }
  async function viewOrder(id){
    const r=await api('/v2/integrations/magento/orders/'+id); const j=await r.json(); const o=j.item||{};
    var rows=''; (o.items||[]).forEach(function(it){rows+='<tr><td>'+it.item_id+'</td><td>'+(it.sku||'')+'</td><td>'+(it.name||'')+'</td><td>'+(it.qty_invoiced||0)+'</td><td>'+(it.qty_refunded||0)+'</td><td>'+fmt(it.price_incl_tax||it.price)+'</td></tr>'});
    document.getElementById('view').innerHTML =
      '<div class="flex items-center justify-between mb-4"><h1 class="text-xl font-semibold">Order #'+(o.increment_id||id)+'</h1><a class="btn btn-soft" href="#/orders">Back</a></div>'+
      '<div class="grid md:grid-cols-2 gap-4"><div class="card"><div class="font-semibold mb-2">Summary</div><div class="text-sm mb-1">Status: <span class="tag">'+(o.status||'')+'</span></div><div class="text-sm mb-1">Grand Total: <b>'+fmt(o.grand_total)+'</b></div><div class="text-sm mb-1">Total Refunded: <b>'+fmt(o.total_refunded||0)+'</b></div></div><div class="card overflow-auto"><div class="font-semibold mb-2">Items</div><table class="table text-sm"><thead><tr><th>Item ID</th><th>SKU</th><th>Name</th><th>Inv.</th><th>Ref.</th><th>Price</th></tr></thead><tbody>'+rows+'</tbody></table></div></div>';
  }

  // FEATURE FLAGS
  async function viewFlags(){
    const r=await api('/v2/feature-flags'); const j=await r.json(); const flags=j.flags||{};
    var rows='';
    Object.keys(flags).sort().forEach(function(k){
      rows += '<tr><td class="py-2 px-2">'+k+'</td><td class="py-2 px-2"><label class="inline-flex items-center gap-2"><input type="checkbox" data-flag="'+k+'" '+(flags[k]?'checked':'')+'/><span class="tag">'+(flags[k]?'on':'off')+'</span></label></td></tr>';
    });
    document.getElementById('view').innerHTML =
      '<div class="mb-4 flex items-center justify-between"><h1 class="text-xl font-semibold">Feature Flags</h1><div class="text-xs text-slate-500">Admin required to toggle</div></div>'+
      '<div class="card overflow-auto"><table class="min-w-full text-sm"><thead><tr class="text-left text-slate-500"><th class="py-2 px-2">Flag</th><th class="py-2 px-2">Value</th></tr></thead><tbody>'+rows+'</tbody></table></div>'+
      '<div class="mt-3 text-xs text-slate-500">Toggles send PUT /v2/feature-flags with <code>x-role: admin</code>.</div>';
    Array.from(document.querySelectorAll('input[type="checkbox"][data-flag]')).forEach(function(el){
      el.addEventListener('change', async function(){
        const key = el.getAttribute('data-flag'); const val = el.checked;
        const res = await fetch('/v2/feature-flags', {
          method:'PUT', headers:{'content-type':'application/json','x-role':'admin'},
          body: JSON.stringify({ flags: { [key]: val }})
        });
        const jr = await res.json(); const ok = jr && jr.ok===true;
        const tag = el.parentElement.querySelector('.tag'); if(tag) tag.textContent = val ? 'on' : 'off';
        (window.notice||notice)((ok?'Updated ':'Failed ')+key+': '+val, ok);
      })
    });
  }

  // ROUTER
  
async function viewRoles(){
  const r = await fetch('/v2/auth/roles');
  const j = await r.json();
  const roles = j.roles||{};
  const current = (localStorage.getItem('role') || 'viewer');
  var rows='';
  Object.keys(roles).forEach(function(k){
    const v = roles[k];
    const perms = (v.permissions||[]).join(', ');
    rows += '<tr><td class="py-2 px-2">'+k+'</td><td class="py-2 px-2">'+(v.label||'')+'</td><td class="py-2 px-2 text-xs text-slate-600">'+perms+'</td></tr>';
  });
  document.getElementById('view').innerHTML =
    '<div class="mb-4 flex items-center justify-between"><h1 class="text-xl font-semibold">Roles</h1>'+
    '<div class="flex items-center gap-2 text-sm">Active role: <select id="roleSel" class="input"><option'+(current==='admin'?' selected':'')+'>admin</option><option'+(current==='viewer'?' selected':'')+'>viewer</option><option'+(current==='sales'?' selected':'')+'>sales</option><option'+(current==='warehouse'?' selected':'')+'>warehouse</option></select><button id="saveRole" class="btn btn-primary">Apply</button></div></div>'+
    '<div class="card overflow-auto"><table class="min-w-full text-sm"><thead><tr class="text-left text-slate-500"><th class="py-2 px-2">Key</th><th class="py-2 px-2">Label</th><th class="py-2 px-2">Permissions</th></tr></thead><tbody>'+rows+'</tbody></table></div>';
  document.getElementById('saveRole').onclick = function(){
    const sel = document.getElementById('roleSel');
    const val = sel.value;
    try{ localStorage.setItem('role', val) }catch(e){}
    // oppdater badge + re-render
    showRole();
    // reload current page to apply header in lists too
    location.reload();
  }
}


async function viewActivity(){
  const u = new URL(location.href);
  const usp = new URLSearchParams(u.hash.split('?')[1]||'');
  const page = Number(usp.get('page')||1);
  const pageSize = Number(usp.get('pageSize')||25);
  const r = await fetch('/v2/activity?page='+page+'&pageSize='+pageSize);
  const j = await r.json();
  const list = j.items||[];
  const total = j.total||list.length;
  const pages = Math.max(1, Math.ceil(total/pageSize));
  var rows='';
  list.forEach(function(x){
    rows += '<tr><td class="py-2 px-2">'+x.id+'</td><td class="py-2 px-2">'+x.method+'</td><td class="py-2 px-2">'+x.url+'</td><td class="py-2 px-2">'+(x.idem||'')+'</td><td class="py-2 px-2">'+x.status+'</td><td class="py-2 px-2">'+x.ms+' ms</td><td class="py-2 px-2 text-right"><a class="btn btn-soft" href="#/activity/'+x.id+'">Open</a></td></tr>';
  });
  document.getElementById('view').innerHTML =
    '<div class="mb-4 flex items-center justify-between"><h1 class="text-xl font-semibold">Activity</h1>'+
    '<div class="flex items-center gap-2"><button id="clearAct" class="btn btn-soft">Clear</button></div></div>'+
    '<div class="card overflow-auto"><table class="min-w-full text-sm"><thead><tr class="text-left text-slate-500"><th class="py-2 px-2">ID</th><th class="py-2 px-2">Method</th><th class="py-2 px-2">Path</th><th class="py-2 px-2">Idempotency-Key</th><th class="py-2 px-2">Status</th><th class="py-2 px-2">Time</th><th class="py-2 px-2"></th></tr></thead><tbody>'+rows+'</tbody></table></div>'+
    '<div class="mt-4 flex items-center justify-between"><button id="actPrev" class="btn btn-soft" '+(page<=1?'disabled':'')+'>Prev</button><div class="text-sm text-slate-600">Page '+page+' of '+pages+' ('+total+')</div><button id="actNext" class="btn btn-soft" '+(page>=pages?'disabled':'')+'>Next</button></div>';
  const prev=document.getElementById('actPrev'); if(prev) prev.onclick=function(){ if(page>1) location.hash = '#/activity?page='+(page-1)+'&pageSize='+pageSize }
  const next=document.getElementById('actNext'); if(next) next.onclick=function(){ if(page<pages) location.hash = '#/activity?page='+(page+1)+'&pageSize='+pageSize }
  const clr=document.getElementById('clearAct'); if(clr) clr.onclick=async function(){
    const res = await fetch('/v2/activity', { method:'DELETE', headers: {'x-role': (localStorage.getItem('role')||'viewer')} })
    const j = await res.json(); (window.notice||function(){})((j.ok?'Cleared':'Failed clear'), j.ok); if(j.ok) location.reload();
  }
}
async function viewActivityItem(id){
  const r = await fetch('/v2/activity/'+id); const j = await r.json(); const x=j.item||{};
  const pretty = (obj)=>{ try{ return JSON.stringify(obj,null,2) } catch(e){ return String(obj) } }
  document.getElementById('view').innerHTML =
    '<div class="mb-4 flex items-center justify-between"><h1 class="text-xl font-semibold">Activity #'+(x.id||id)+'</h1><a class="btn btn-soft" href="#/activity">Back</a></div>'+
    '<div class="grid md:grid-cols-2 gap-4">'+
      '<div class="card"><div class="font-semibold mb-2">Summary</div>'+
        '<div class="text-sm">Method: <b>'+(x.method||'')+'</b></div>'+
        '<div class="text-sm">Path: <code>'+(x.url||'')+'</code></div>'+
        '<div class="text-sm">Role: '+(x.role||'')+'</div>'+
        '<div class="text-sm">Idempotency-Key: <code>'+(x.idem||'')+'</code></div>'+
        '<div class="text-sm">Status: '+(x.status||'')+'</div>'+
        '<div class="text-sm">Time: '+(x.ms||'?')+' ms</div>'+
      '</div>'+
      '<div class="card"><div class="font-semibold mb-2">Request Body</div><pre class="text-xs whitespace-pre-wrap">'+(x.body||'')+'</pre></div>'+
      '<div class="card md:col-span-2"><div class="font-semibold mb-2">Response (truncated)</div><pre class="text-xs whitespace-pre-wrap">'+(x.res||'')+'</pre></div>'+
    '</div>';
}

async function router(){
    var hash=location.hash||'#/orders'; var parts=hash.split('/'); var route=parts[1]||'orders'; var arg=parts[2];
    if(route==='products') return viewProducts();
    if(route==='product') return viewProduct(decodeURIComponent(arg||'TEST'));
    if(route==='orders') return viewOrders();
    if(route==='order') return viewOrder(arg||'1');
    if(route==='flags') return viewFlags();
    if(route==='roles') return viewRoles();
    if(route==='activity') { if(arg) return viewActivityItem(arg); return viewActivity(); }
    return viewOrders();
  }
  



async function showRole(){
  // sett badge fra localStorage som rask feedback
  let local = 'viewer';
  try { local = localStorage.getItem('role') || 'viewer'; } catch(e){}
  const tag = document.getElementById('roleTag');
  if(tag){ tag.textContent = local; }

  const applyBtns = (role)=>{
    const isAdmin = role === 'admin';
    document.querySelectorAll('.btn-primary').forEach(b=>{
      b.disabled = !isAdmin;
      b.classList.toggle('opacity-60', !isAdmin);
      b.classList.toggle('cursor-not-allowed', !isAdmin);
    });
  };
  applyBtns(local);

  // verifiser med whoami (nå har vi fetch-interceptor som legger på x-role)
  try{
    const r = await fetch('/v2/auth/whoami');
    const j = await r.json();
    const serverRole = roleKeyFromPayload(j);
    if(tag){ tag.textContent = serverRole; }
    applyBtns(serverRole);
  }catch(e){
    // behold local fallback
    console.warn('whoami failed', e);
  }
}




addEventListener('hashchange', router); router(); showRole();
})();
</script>

<script>
function currentRouteParts(){
  var h = location.hash || '#/orders';
  var p = h.split('/');
  // #/product/<SKU>
  return { route: p[1]||'', arg: p[2]||'' }
}
async function fetchVariantsForSku(sku){
  try{
    const r = await fetch('/v2/integrations/magento/products/'+encodeURIComponent(sku)+'/variants');
    return await r.json();
  }catch(e){ return { ok:false, items:[], source:'error' } }
}
function ensureVariantsBox(){
  let box = document.getElementById('variantsBox');
  if(!box){
    const anchor = document.getElementById('productMeta') || document.getElementById('view');
    box = document.createElement('div');
    box.id = 'variantsBox';
    box.className = 'card mt-4';
    box.innerHTML = '<div class="font-semibold mb-2">Variants</div><div id="variantsBody" class="text-sm text-slate-600">Loading…</div>';
    anchor && anchor.appendChild(box);
  }
  return box;
}
function renderVariantsBody(items, source){
  const el = document.getElementById('variantsBody');
  if(!el) return;
  if(!items || !items.length){
    el.innerHTML = '<div class="text-slate-500">No variants (source: '+(source||'?')+')</div>';
    return;
  }
  var rows='';
  items.forEach(it=>{
    const st = (it.status===1?'enabled':(it.status===2?'disabled':String(it.status||'')));
    rows += '<tr><td class="py-2 px-2">'+(it.sku||'')+'</td><td class="py-2 px-2">'+(it.name||'')+'</td><td class="py-2 px-2">'+(typeof it.price==='number'?it.price:'')+'</td><td class="py-2 px-2">'+st+'</td></tr>';
  });
  el.innerHTML = '<div class="mb-2 text-xs text-slate-500">source: '+(source||'?')+'</div>'+
    '<div class="overflow-auto"><table class="min-w-full text-sm"><thead><tr class="text-left text-slate-500"><th class="py-2 px-2">SKU</th><th class="py-2 px-2">Name</th><th class="py-2 px-2">Price</th><th class="py-2 px-2">Status</th></tr></thead><tbody>'+rows+'</tbody></table></div>';
}
async function postRenderVariantsFix(){
  const parts = currentRouteParts();
  if(parts.route !== 'product') return; // kun på produktsiden
  const sku = decodeURIComponent(parts.arg || '').trim() || (function(){
    // fallbacks: forsøk å plukke SKU fra heading/body hvis noen viser den
    const h = document.querySelector('#view h1');
    if(h){ return (h.textContent||'').trim() }
    return '';
  })();

  if(!sku) return;
  ensureVariantsBox();
  renderVariantsBody([], 'loading');

  const j = await fetchVariantsForSku(sku);
  const items = j.items || [];
  renderVariantsBody(items, j.source || 'unknown');
}
// oppdater ved hash-endring (navigering)
addEventListener('hashchange', ()=>{ setTimeout(postRenderVariantsFix, 0) })
</script>
</body></html>`;
    reply.header('Cache-Control','no-store').type('text/html; charset=utf-8').send(html);
  });
}

async function loadVariants(sku){
  try{
    const r = await fetch('/v2/integrations/magento/products/'+encodeURIComponent(sku)+'/variants');
    const j = await r.json();
    renderVariants(j.items||[], j.source||'?')
  }catch(e){
    renderVariants([], 'error')
  }
}
function renderVariants(items, source){
  const el = document.getElementById('variantsBody');
  if(!el) return;
  if(!items.length){
    el.innerHTML = '<div class="text-slate-500">No variants (source: '+source+')</div>';
    return;
  }
  var rows = '';
  items.forEach(it=>{
    const st = (it.status===1?'enabled':(it.status===2?'disabled':String(it.status)));
    rows += '<tr><td class="py-2 px-2">'+(it.sku||'')+'</td><td class="py-2 px-2">'+(it.name||'')+'</td><td class="py-2 px-2">'+(typeof it.price==='number'?(''+it.price):'')+'</td><td class="py-2 px-2">'+st+'</td></tr>';
  })
  el.innerHTML =
    '<div class="mb-2 text-xs text-slate-500">source: '+source+'</div>'+
    '<div class="overflow-auto"><table class="min-w-full text-sm"><thead><tr class="text-left text-slate-500"><th class="py-2 px-2">SKU</th><th class="py-2 px-2">Name</th><th class="py-2 px-2">Price</th><th class="py-2 px-2">Status</th></tr></thead><tbody>'+rows+'</tbody></table></div>';
}
